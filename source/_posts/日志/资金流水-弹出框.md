---
title: 资金流水-弹出框
date: 2022-7-22 14:24:07
cover: 
tags:
- 日志
---
```html
<template>
  <div class="app-test">
    <el-tabs v-model="active" type="border-card" @tab-click="handleTabClick">
      <el-tab-pane v-for="item in tabs" :key="item.key" :name="item.key" :label="item.text">

        <ws-custom-app
            isMicro
            :userInfo="userInfo"
            :id="item.key"
            :testAccount="DEV_LOGIN_USER_ACCOUNT"
            :testSystemId="SYSTEM_ID"
            :showSelection="true"
            :selection="true"
            :actions="item.actions"
            :showCreateBtn="false"
            :env="env"
            :filterConfig="filterConfig"
            @mul-opt-upload="mulOptUpload"
            @mul-opt-template="mulOptTtemplate"
            @mul-opt-input="handleIdentifyInput"
            @mul-opt-param="handleIdentifyParam"
            @mul-opt-select="handleIdentifySelect"
            @mul-opt-liquidate-input="handleMulOptLiquidateInput"
            @mul-opt-accrual="handleProvisionInfo"
            @mul-opt-summary="modelHandleInfo"
            @mul-opt-template-summary="mulOptTtemplateSummary"
        >
        </ws-custom-app>

        <el-dropdown @command="handleCommand">
          <el-button type="primary">
            摘要编辑<i class="el-icon-arrow-down el-icon--right"></i>
          </el-button>
          <el-dropdown-menu slot="dropdown">
            <el-dropdown-item command="download">下载摘要模版</el-dropdown-item>
            <el-dropdown-item command="upload">导入摘要</el-dropdown-item>
          </el-dropdown-menu>
        </el-dropdown>

      </el-tab-pane>

    </el-tabs>

    <el-dialog
        title="模版与导入"
        :visible.sync="modelDialogVisible"
        width="20%"
        center
        :before-close="modelHandleClose">
      <el-row>
        <el-col :span="12" style="text-align: center">
          <el-button size="small" type="primary" @click="modelDialogVisible = !modelDialogVisible"
                     icon="el-icon-upload" style="width:145px"> 摘 要 导 入
          </el-button>
        </el-col>
        <el-col :span="12" style="text-align: center">
          <el-button size="small" type="primary" @click="modelDialogVisible = !modelDialogVisible"
                     icon="el-icon-download" style="width:145px">摘要模版下载
          </el-button>
        </el-col>

      </el-row>
      <el-row style="margin-top: 10px">
        <el-col :span="12" style="text-align: center">
          <el-button size="small" type="primary" @click="modelDialogVisible = !modelDialogVisible"
                     icon="el-icon-upload" style="width:145px">流 水 导 入</el-button>
        </el-col>
        <el-col :span="12" style="text-align: center">
          <el-button size="small" type="primary" @click="modelDialogVisible = !modelDialogVisible"
                     icon="el-icon-download" style="width:145px">流水模版下载</el-button>
        </el-col>
      </el-row>

      <span slot="footer" class="dialog-footer">
  </span>
    </el-dialog>

    <el-dialog title="待确认资金月底计提" :visible.sync="provisionFormDialog" width="500px">
      <el-form :model="provisionForm" label-position="left" label-width="80px">
        <el-form-item label="会计月份">
          <el-date-picker
              v-model="provisionForm.accountMonth"
              type="month"
              value-format="yyyy-MM"
              :clearable="false"
              placeholder="计提月份"
          >
          </el-date-picker>
        </el-form-item>
        <el-form-item label="账户Id">
          <el-select placeholder="账户Id" v-model="provisionForm.accountId" clearable filterable
                     :style="{'margin-right':'5px','width':'220px'}">
            <el-option
                v-for="item in account"
                :key="item.value"
                :label="item.value"
                :value="item.value">
            </el-option>
          </el-select>

          <el-button @click="getProvisionInfo">查看计提信息</el-button>
        </el-form-item>
        <el-form-item label="计提信息" class="span-2">
          <el-input
              class="mark-input"
              size="mini"
              type="textarea"
              :disabled="false"
              :rows="5"
              v-model="provisionForm.info"
              style="width: 350px"
          ></el-input>
        </el-form-item>
        <el-form-item label="批次场景" class="span-2">
          <el-select v-model="sceneType.sceneId" placeholder="请选择" filterable>
            <el-option
                v-for="item in sceneType"
                :key="item.sceneName"
                :label="item.sceneName"
                :value="item.sceneId">
            </el-option>
          </el-select>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="provisionFormCancel">取 消</el-button>
        <el-button type="primary" @click="doProvision" :loading="loading">确定计提</el-button>
      </span>
    </el-dialog>

    <el-dialog :title="operateName" :visible.sync="showIdentifyDialog" width="555px">
      <el-form ref="changeStatusForm" :model="inputForm" label-position="left" label-width="70px">
        <el-form-item label="操作类型">
          <template>
            <el-radio v-model="operateType" label=1>按月按场景汇总</el-radio>
            <el-radio v-model="operateType" label=2>按天按场景汇总</el-radio>
            <el-radio v-model="operateType" label=3>按流水号1对1汇总</el-radio>
          </template>
        </el-form-item>
        <el-form-item label="摘要类型">
          <template>
            <el-radio v-model="summaryType" label=1>银行流水摘要</el-radio>
            <el-radio v-model="summaryType" label=2>补充摘要</el-radio>
          </template>
        </el-form-item>
        <el-form-item label="摘要" v-show="this.summaryType == 2">
          <el-input type="textarea" :rows="2" style="width: 70%" placeholder="请输入摘要"
                    v-model="inputForm.summaryArea"></el-input>
        </el-form-item>
        <el-form-item label="录入流水" prop="textarea" v-show="handelBatchType === 'input' ">
          <el-input type="textarea" :rows="15" style="width: 80%" placeholder="请输银行流水号"
                    v-model="inputForm.textarea"></el-input>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="showIdentifyDialog = false">取 消</el-button>
        <el-button type="primary" @click="doIdentify">确 定</el-button>
      </span>
    </el-dialog>
    <el-dialog title="录入资金退费单据" :visible.sync="showLiquidateInputDialog" width="400px">
      <el-form ref="changeStatusForm" :model="inputForm" label-position="left" label-width="80px">
        <el-form-item label="退费流水" prop="textarea">
          <el-input type="textarea" :rows="15" placeholder="请输入退费银行流水号" v-model="inputForm.textarea"></el-input>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="showLiquidateInputDialog = false">取 消</el-button>
        <el-button type="primary" @click="hubhandleLiquidateInput">确 定</el-button>
      </span>
    </el-dialog>

    <input ref="file" type="file" class="hide" @change="fileChange"/>
    <input ref="summary" type="file" class="hide" @change="summaryChange"/>
  </div>
</template>

<script>
import {DEV_LOGIN_USER_ACCOUNT, SYSTEM_ID} from '@/utils/config'
// import { kiloSplit } from '@/utils/utils'
import api from '@/utils/api'

export default {
  data () {
    return {
      DEV_LOGIN_USER_ACCOUNT,
      SYSTEM_ID,
      env: process.env.NODE_ENV,
      active: 'liquidate_bankflow_unconfirm',
      operateItem: {
        width: 180,
        number: 4
      },
      loading: false,
      selection: [],
      refleshCb: () => {
      },
      showIdentifyDialog: false,
      showLiquidateInputDialog: false,
      operateType: 0,
      summaryType: 0,
      handelBatchType: '',
      operateName: '',
      inputForm: {
        textarea: '',
        summaryArea: ''
      },
      // 月底计提提示框
      provisionFormDialog: false,
      provisionForm: {
        accountMonth: '',
        accountId: '',
        info: ''
      },
      // 模版
      modelDialogVisible: false,
      // 场景
      sceneType: [],
      account: [],
      tabs: [
        {
          key: 'liquidate_bankflow_unconfirm',
          text: '待确认资金流水',
          operateItem: {
            width: 100,
            number: 4
          },
          actions: [
            {
              title: () => {
                return '月底计提'
              },
              name: 'mul-opt-accrual',
              loading: false,
              type: 'primary',
              plain: false,
              permission: '',
              icon: '',
              show: selection => {
                return true
              }
            },
            {
              title: () => {
                return '模版与导入'
              },
              name: 'mul-opt-summary',
              loading: false,
              type: 'primary',
              plain: false,
              permission: '',
              icon: '',
              show: selection => {
                return true
              }
            },
            {
              title: () => {
                return '摘要模板'
              },
              name: 'mul-opt-template-summary',
              loading: false,
              type: 'primary',
              plain: false,
              permission: '',
              icon: '',
              show: selection => {
                return true
              }
            },
            {
              title: () => {
                return '导入'
              },
              name: 'mul-opt-upload',
              loading: false,
              type: 'primary',
              plain: false,
              permission: '',
              icon: '',
              show: selection => {
                return true
              }
            },
            {
              title: () => {
                return '导入模板'
              },
              name: 'mul-opt-template',
              loading: false,
              type: 'primary',
              plain: false,
              permission: '',
              icon: '',
              show: selection => {
                return true
              }
            }
            // {
            //   title: () => {
            //     return '按选择识别'
            //   },
            //   name: 'mul-opt-select',
            //   loading: false,
            //   type: 'primary',
            //   plain: false,
            //   permission: '',
            //   icon: '',
            //   show: selection => {
            //     return true
            //   }
            // },
            // {
            //   title: () => {
            //     return '按条件识别'
            //   },
            //   name: 'mul-opt-param',
            //   loading: false,
            //   type: 'primary',
            //   plain: false,
            //   permission: '',
            //   icon: '',
            //   show: selection => {
            //     return true
            //   }
            // },
            // {
            //   title: () => {
            //     return '按录入识别'
            //   },
            //   name: 'mul-opt-input',
            //   loading: false,
            //   type: 'primary',
            //   plain: false,
            //   permission: '',
            //   icon: '',
            //   show: selection => {
            //     return true
            //   }
            // },
            // {
            //   title: () => {
            //     return '按录入退费清算'
            //   },
            //   name: 'mul-opt-liquidate-input',
            //   loading: false,
            //   type: 'primary',
            //   plain: false,
            //   permission: '',
            //   icon: '',
            //   show: selection => {
            //     return true
            //   }
            // }
          ]
        },
        {
          key: 'liquidate_bankflow_confirm',
          text: '已确认资金流水',
          operateItem: {
            width: 100,
            number: 4
          }
        }
      ],
      showDialog: false,
      changeForm: {
        selectMethods: '',
        textarea: '',
        flowNo: ''
      },
      selectMethodsOption: [
        {
          value: 'param',
          text: '按条件识别'
        },
        {
          value: 'input',
          text: '按录入识别'
        }
      ],
      changeRules: {
        selectMethods: [{required: true, message: '请输入', trigger: 'blur'}],
        textarea: [{required: true, message: '请输入', trigger: 'blur'}],
        flowNo: [{required: true, message: '请输入', trigger: 'blur'}]
      },
      searchData: {}
    }
  },
  computed: {
    userInfo (data) {
      return this.$store.state.login.userInfo
    }
  },
  methods: {
    handleCommand (command) {
      if (command === 'download') {
        this.mulOptTtemplateSummary()
      }
      if (command === 'upload') {
        this.mulOptSummary()
      }
    },
    // 下载模版关闭
    modelHandleClose (done) {
      this.$confirm('确认关闭？')
        .then(_ => {
          done()
        })
        .catch(_ => {
        })
    },
    modelHandleInfo () {
      this.modelDialogVisible = true
    },
    changeLoading () {
      this.loading = !this.loading
    },
    getProvisionInfo () {
      this.$http
        .post(api.liquidateProvision, {
          accountMonth: this.provisionForm.accountMonth,
          accountId: this.provisionForm.accountId
        })
        .then(res => {
          if (res.code === 0) {
            this.provisionForm.info = res.message
          } else {
            this.$message.warning(res.message)
          }
        })
    },
    provisionFormCancel () {
      this.provisionFormDialog = false
    },
    doProvision () {
      this.$confirm('是否计提当前账户：' + this.provisionForm.accountId, '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        this.changeLoading()
        this.$http
          .post(api.liquidateDoProvision, {
            accountMonth: this.provisionForm.accountMonth,
            accountId: this.provisionForm.accountId,
            sceneId: this.sceneType.sceneId
          })
          .then(res => {
            this.provisionFormDialog = false
            if (res.code === 0) {
              this.$message.success(res.message)
            } else {
              this.$message.warning(res.message)
            }
          })
          .finally(() => {
            this.changeLoading()
          })
      })
    },
    filterConfig (data) {
      this.searchData = data
      return data
    },
    init (to) {
    },
    mulOptUpload (selection, action) {
      this.$refs.file.click()
    },
    mulOptSummary (selection, action) {
      this.$refs.summary.click()
    },
    handleTabClick (val) {
      this.active = val.name
      this.$router.push({
        path: `/$define/${this.active}`
      })
    },
    handleIdentifyParam () {
      this.inputForm.textarea = ''
      this.inputForm.summaryArea = ''
      this.operateType = 0
      this.operateName = '按条件识别'
      this.handelBatchType = 'param'
      this.summaryType = 0
      this.showIdentifyDialog = true
    },
    handleIdentifySelect (selection, action, cb) {
      if (selection.length === 0) {
        this.$message.warning('请选择数据')
        return
      }
      this.selection = selection
      this.operateName = '按选择识别'
      this.handelBatchType = 'select'
      this.inputForm.textarea = ''
      this.inputForm.summaryArea = ''
      this.operateType = 0
      this.summaryType = 0
      this.showIdentifyDialog = true
    },
    handleIdentifyInput (selection, action, cb) {
      this.inputForm.textarea = ''
      this.inputForm.summaryArea = ''
      this.operateType = 0
      this.operateName = '按录入识别'
      this.handelBatchType = 'input'
      this.summaryType = 0
      this.showIdentifyDialog = true
    },
    handleMulOptLiquidateInput () {
      this.inputForm.textarea = ''
      this.showLiquidateInputDialog = true
    },
    handleProvisionInfo () {
      this.provisionForm.info = ''
      this.provisionFormDialog = true
      this.getSceneType()
      this.getAccountId()
    },
    mulOptTtemplate () {
      window.open(
        'https://common-1252347619.cosgz.myqcloud.com/template/e15e1b68-77a0-47e6-bdaa-93ef4cd4a35d.xlsx',
        '_self'
      )
    },
    mulOptTtemplateSummary () {
      window.open(
        'https://common-1252347619.cosgz.myqcloud.com/template/1460db96-3f2e-4e33-953f-8f880a9554c5.xlsx',
        '_self'
      )
    },
    fileChange (e) {
      const fileInput = e.target
      const reqFile = new FormData()
      reqFile.append('file', fileInput.files[0])
      this.$http
        .post(api.liquidateBankUpload, reqFile)
        .then(res => {
          if (res.code === 0) {
            this.$message.success(res.message)
            e.target.value = ''
            this.refleshCb()
          } else {
            this.$message.warning(res.message)
            e.target.value = ''
          }
        })
        .catch(() => {
          e.target.value = ''
        })
    },
    summaryChange (e) {
      const fileInput = e.target
      const reqFile = new FormData()
      reqFile.append('file', fileInput.files[0])
      this.$http
        .post(api.liquidateBankSummary, reqFile)
        .then(res => {
          if (res.code === 0) {
            this.$message.success(res.message)
            e.target.value = ''
            this.refleshCb()
          } else {
            this.$message.warning(res.message)
            e.target.value = ''
          }
        })
        .catch(() => {
          e.target.value = ''
        })
    },
    getSceneType () {
      let param = {}
      param = {}
      this.$http.post(api.liquidateSceneType, param).then(res => {
        if (res.code === 0) {
          this.sceneType = res.result.data
        } else {
          this.$message.warning(res.message)
        }
      })
    },
    getAccountId () {
      let param = {}
      param = {}
      this.$http.post(api.liquidateAccountId, param).then(res => {
        if (res.code === 0) {
          this.account = res.result
        } else {
          this.$message.warning(res.message)
        }
      })
    },
    handleMulOptSelect () {
      if (this.operateType === 0) {
        this.$message.warning('请选择类型')
        return
      }
      let ids = this.selection.map(v => {
        return v.id
      })
      let param = {}
      param = {
        operateType: this.operateType,
        ids: ids
      }
      this.$http.post(api.liquidateBankSelect, param).then(res => {
        if (res.code === 0) {
          this.$message.success(res.message)
          this.refleshCb()
          this.showIdentifyDialog = false
        } else {
          this.$message.warning(res.message)
        }
      })
    },
    handleMulOptParam () {
      if (this.operateType === 0) {
        this.$message.warning('请选择类型')
        return
      }
      let param = this.searchData
      param.filter.operateType = {'value': this.operateType}
      this.$http.post(api.liquidateBankParam, {...param}).then(res => {
        if (res.code === 0) {
          this.$message.success(res.message)
          this.refleshCb()
          this.showDialog = false
          this.showIdentifyDialog = false
        } else {
          this.$message.warning(res.message)
        }
      })
    },
    doIdentify () {
      if (this.operateType === 0) {
        this.$message.warning('请选择操作类型')
        return
      }
      if (this.summaryType === 0) {
        this.$message.warning('请选择摘要类型')
        return
      }
      if (this.summaryType === '2' && this.inputForm.summaryArea === '') {
        this.$message.warning('请填写摘要')
        return
      }
      let url = ''
      let param = {}
      if (this.handelBatchType === 'select') {
        url = api.liquidateBankSelect
        let ids = this.selection.map(v => {
          return v.id
        })
        param = {
          summaryType: this.summaryType,
          operateType: this.operateType,
          summaryText: this.inputForm.summaryArea,
          ids: ids
        }
      }
      if (this.handelBatchType === 'param') {
        url = api.liquidateBankParam
        param = this.searchData
        param.filter.summaryType = {'value': this.summaryType}
        param.filter.summaryText = {'value': this.inputForm.summaryArea}
        param.filter.operateType = {'value': this.operateType}
      }
      if (this.handelBatchType === 'input') {
        url = api.liquidateBankInput
        param = {
          summaryType: this.summaryType,
          summaryText: this.inputForm.summaryArea,
          operateType: this.operateType,
          itemText: this.inputForm.textarea
        }
      }
      this.$confirm('是否批量' + this.operateName + '?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      })
        .then(() => {
          this.$http
            .post(url, {...param})
            .then(res => {
              if (res.code === 0) {
                this.$message.success(res.message)
                this.refleshCb()
              } else {
                this.$message.warning(res.message)
              }
            })
            .finally(() => {
              this.showIdentifyDialog = false
            })
        })
    },
    hubhandleLiquidateInput () {
      let url = api.liquidateBankLiquidateInput
      let param = {}
      param = {
        itemText: this.inputForm.textarea
      }
      this.$confirm('是否按录入退费清算?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      })
        .then(() => {
          this.$http
            .post(url, {...param})
            .then(res => {
              if (res.code === 0) {
                this.$message.success(res.message)
                this.refleshCb()
              } else {
                this.$message.warning(res.message)
              }
            })
            .finally(() => {
              this.showLiquidateInputDialog = false
            })
        })
    }
  },
  beforeRouteEnter (to, from, next) {
    next(vm => vm.init(to))
  },
  beforeRouteUpdate (to, from, next) {
    this.init(to)
    next()
  }
}
</script>

<style lang="scss" scoped></style>

```
